steps:
  # Step 1: Install Terraform once and make it reusable in next steps
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
    id: 'Install Terraform'
    entrypoint: 'sh'
    args:
      - -c
      - |
        apt-get update && apt-get install -y unzip curl bash
        rm -rf terraform  # Remove directory if it exists
        curl -fsSL https://releases.hashicorp.com/terraform/1.6.6/terraform_1.6.6_linux_amd64.zip -o terraform.zip
        unzip -o terraform.zip
        chmod +x terraform
        mv terraform /usr/local/bin/
        terraform version

  # Step 2: Run Terraform commands from terraform/ directory
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
    id: 'Terraform Init & Apply'
    dir: 'terraform'
    entrypoint: 'sh'
    args:
      - -c
      - |
        # Install Terraform again (shared cache not preserved between steps in cloud-sdk image)
        apt-get update && apt-get install -y unzip curl bash
        curl -fsSL https://releases.hashicorp.com/terraform/1.6.6/terraform_1.6.6_linux_amd64.zip -o terraform.zip
        unzip -o terraform.zip
        chmod +x terraform
        mv terraform /usr/local/bin/

        # Fetch project secrets
        project_id=$(gcloud secrets versions access latest --secret=tf-project-id)
        project_number=$(gcloud secrets versions access latest --secret=tf-project-number)

        # Terraform workflow
        terraform init -input=false
        terraform plan -input=false -var="project_id=$project_id" -var="project_number=$project_number" -out=tfplan
        terraform apply -input=false -auto-approve tfplan

options:
  logging: CLOUD_LOGGING_ONLY

